<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>http://localhost:8080/iframe-with-redirects.html</title>

<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.14.2/d3.min.js"-->
<!--            integrity="sha256-M2M+sgC2bZ4r73FO1LV5JmHiS5COwEb2Uqw7EbsHmBY=" crossorigin="anonymous"></script>-->
    <script src="d3.min.js"></script>

</head>
<body>



<script type="text/javascript">
	const data = {"requestId":"F467B808225139AF2185FCA007D797C1","url":"http://localhost:8080/iframe-with-redirects.html","method":"GET","type":"Document","encodedBytes":469,"value":469,"frameId":"A59D82757E2B8ECB98ECF5652BA2E61E","children":[{"requestId":"837DAB5BF6E8436B340C66C4AB629C6B","url":"http://localhost:8080/redirect-asset.html","method":"GET","type":"Document","encodedBytes":453,"value":453,"frameId":"7EBC9FF5A90CF14150CD2299AE7BC923","children":[{"requestId":"35532.3","url":"http://localhost:8080/redirect-js","method":"GET","type":"Script","encodedBytes":438,"value":438,"frameId":"7EBC9FF5A90CF14150CD2299AE7BC923","children":[{"requestId":"35532.3","url":"http://localhost:8080/redirect-two","method":"GET","type":"Script","encodedBytes":438,"value":438,"frameId":"7EBC9FF5A90CF14150CD2299AE7BC923","children":[{"requestId":"35532.3","url":"http://localhost:8080/js/load-script.js","method":"GET","type":"Script","encodedBytes":438,"value":438,"frameId":"7EBC9FF5A90CF14150CD2299AE7BC923","children":[{"requestId":"35532.5","url":"http://localhost:8080/js/load-other.js","method":"GET","type":"Script","encodedBytes":401,"value":401,"frameId":"7EBC9FF5A90CF14150CD2299AE7BC923","children":[{"requestId":"35532.6","url":"http://localhost:8080/assets/some-data.json","method":"GET","type":"Fetch","encodedBytes":319,"value":319,"frameId":"7EBC9FF5A90CF14150CD2299AE7BC923","children":[]}]}]}]}]}]}]};

	// const width = 954;
	const width = window.innerWidth;
	// const height = 1060;
	const height = window.innerHeight - 30;

	const format = d3.format(',d');
	const color = d3.scaleSequential([8, 0], d3.interpolateMagma);

	const treemap = data => d3.treemap()
		.size([width, height])
		.paddingOuter(3)
		.paddingTop(19)
		.paddingInner(1)
		.round(true)
		(d3.hierarchy(data)
			.sum(d =>  d.value)
			.sort((a, b) => b.value - a.value));

	const root = treemap(data);

	const svg = d3.create('svg')
		.attr('viewBox', [0, 0, width, height])
		.style('font', '10px sans-serif');

	const shadow = 'shadow';

	svg.append('filter')
		.attr('id', shadow)
		.append('feDropShadow')
		.attr('flood-opacity', 0.3)
		.attr('dx', 0)
		.attr('stdDeviation', 3);

	const node = svg.selectAll('g')
		.data(d3.nest().key(d => d.height).entries(root.descendants()))
		.join('g')
		.attr('filter', shadow)
		.selectAll('g')
		.data(d => d.values)
		.join('g')
		.attr('transform', d => `translate(${d.x0},${d.y0})`);

	node.append('title')
		.text(d => `${d.ancestors().reverse().map(d => d.data.url).join('/')}\n${format(d.value)}`);

	node.append('rect')
		.attr('id', (d, i) => (d.nodeUid = `node-${i}`))
		.attr('fill', d => color(d.height))
		.attr('width', d => d.x1 - d.x0)
		.attr('height', d => d.y1 - d.y0);

	node.append('clipPath')
		.attr('id', (d, i) => (d.clipUid = `clip-${i}`))
		.append('use')
		.attr('xlink:href', d => `#${d.nodeUid}`);

	node.append('text')
		.attr('clip-path', d => d.clipUid)
		.selectAll('tspan')
		.data(d => {
			return `${d.data.url} ${d.value} ${d.data.encodedBytes}`;
			// return d.data.url.split(/(?=[A-Z][^A-Z])/g).concat(format(d.data.encodedBytes))
		})
		.join('tspan')
		.attr('fill-opacity', (d, i, nodes) => i === nodes.length - 1 ? 0.7 : null)
		.text(d => d);

	node.filter(d => d.data.children).selectAll('tspan')
		.attr('dx', 3)
		.attr('y', 13);

	node.filter(d => !d.data.children).selectAll('tspan')
		.attr('x', 3)
		.attr('y', (d, i, nodes) => `${(i === nodes.length - 1) * 0.3 + 1.1 + i * 0.9}em`);

	document.body.appendChild(svg.node());
</script>
</body>
</html>
